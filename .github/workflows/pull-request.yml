name: "VerificaÃ§Ã£o de Qualidade"

on:
  pull_request:
    branches: ["main", "develop"]

permissions:
  contents: read
  pull-requests: write
  actions: read
  checks: write
  statuses: write
  security-events: write

concurrency:
  group: "quality-security-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  # -------------------------------------------------------------
  # 1. COMPILAÃ‡ÃƒO + TESTES UNITÃRIOS (fan-out: matriz)
  # -------------------------------------------------------------
  build-test:
    name: "Build & Unit Tests"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        java: ["17", "21"]

    steps:
      - uses: actions/checkout@v4

      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ matrix.java }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-${{ matrix.java }}-

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: temurin
          cache: "maven"

      - name: Run tests
        run: mvn -B -ntp clean verify

      - name: Upload surefire results
        uses: actions/upload-artifact@v4
        with:
          name: surefire-${{ matrix.java }}
          path: target/surefire-reports

  # -------------------------------------------------------------
  # 2. ARQUITETURA
  # -------------------------------------------------------------
  architecture:
    name: "Architecture Review"
    runs-on: ubuntu-latest
    needs: build-test

    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: maven

      - name: ArquUnit validation
        if: ${{ hashFiles('**/*ArchitectureTest.java') != '' }}
        run: mvn -Dtest=ArquUnitTests test

      # -------------------------------------------------------------
      # Upload report
      # -------------------------------------------------------------
      - name: Upload ArquUnit report
        uses: actions/upload-artifact@v4
        with:
          name: arquunit-report
          path: target/surefire-reports

  # -------------------------------------------------------------
  # 3. DESIGN DE CÃ“DIGO
  # -------------------------------------------------------------
  linting:
    name: "Code Style"
    runs-on: ubuntu-latest
    needs: build-test

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: "maven"

      - if: ${{ hashFiles('**/*pom.xml') != '' && contains(steps.prepare_maven.outputs.plugins, 'spotless-maven-plugin') }}
        run: mvn spotless:check

      - run: |
          wget -q https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.17.0/checkstyle-10.17.0-all.jar -O checkstyle.jar
          java -jar checkstyle.jar \
            -c .github/config/checkstyle/checkstyle.xml \
            -f xml \
            -o checkstyle-result.xml \
            src/main/java src/test/java || true

      - name: Convert Checkstyle XML to Markdown
        run: |
          echo "## Checkstyle Report" > checkstyle.md
          echo "" >> checkstyle.md
          echo "| File | Line | Message |" >> checkstyle.md
          echo "|------|------|---------|" >> checkstyle.md

          xmllint --xpath "//*[name()='file']/*[name()='error']" checkstyle-result.xml 2>/dev/null | \
          sed 's/></>\n</g' | \
          while read -r line; do
            FILE=$(echo "$line" | grep -o 'name="[^"]*"' | head -1 | cut -d'"' -f2)
            LINE=$(echo "$line" | grep -o 'line="[^"]*"' | head -1 | cut -d'"' -f2)
            MSG=$(echo "$line" | grep -o 'message="[^"]*"' | head -1 | cut -d'"' -f2)
            echo "| $FILE | $LINE | $MSG |" >> checkstyle.md
          done

          if ! grep -q "|" checkstyle.md ; then
            echo "Nenhum problema encontrado ðŸŽ‰" >> checkstyle.md
          fi

      - name: Add report to GitHub Job Summary
        run: cat checkstyle.md >> $GITHUB_STEP_SUMMARY

      - name: Post Checkstyle report to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: checkstyle.md

  # -------------------------------------------------------------
  # 4. SEGURANÃ‡A DEPENDÃŠNCIAS
  # -------------------------------------------------------------

  # -------------------------------------------------------------
  # 5. SEGURANÃ‡A B. SAST
  # -------------------------------------------------------------

  # -------------------------------------------------------------
  # 6. MERGE ENFORCEMENT
  # -------------------------------------------------------------
  enforce:
    name: "Enterprise Gatekeeper"
    runs-on: ubuntu-latest
    needs: [build-test, linting, architecture]

    steps:
      - name: All checks passed
        run: |
          echo "âœ” Todas as etapas de Qualidade + SeguranÃ§a concluÃ­das."
