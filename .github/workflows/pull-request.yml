name: "Verificação de Qualidade"

on:
  pull_request:
    branches: ["main", "develop"]

permissions:
  contents: read
  pull-requests: write
  actions: read
  checks: write
  statuses: write
  security-events: write

concurrency:
  group: "quality-security-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  # -------------------------------------------------------------
  # 1. COMPILAÇÃO + TESTES UNITÁRIOS (fan-out: matriz)
  # -------------------------------------------------------------
  build-test:
    name: "Build & Unit Tests"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        java: ["17", "21"]

    steps:
      - uses: actions/checkout@v4

      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ matrix.java }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-${{ matrix.java }}-

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: temurin
          cache: "maven"

      - name: Run tests
        run: mvn -B -ntp clean verify

      - name: Upload surefire results
        uses: actions/upload-artifact@v4
        with:
          name: surefire-${{ matrix.java }}
          path: target/surefire-reports

  # -------------------------------------------------------------
  # 2. ARQUITETURA
  # -------------------------------------------------------------
  architecture:
    name: "Architecture Review"
    runs-on: ubuntu-latest
    needs: build-test

    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: maven

      - name: ArquUnit validation
        if: ${{ hashFiles('**/*ArchitectureTest.java') != '' }}
        run: mvn -Dtest=ArquUnitTests test

      # -------------------------------------------------------------
      # Upload report
      # -------------------------------------------------------------
      - name: Upload ArquUnit report
        uses: actions/upload-artifact@v4
        with:
          name: arquunit-report
          path: target/surefire-reports

  # -------------------------------------------------------------
  # 3. DESIGN DE CÓDIGO
  # -------------------------------------------------------------
  linting:
    name: "Code Style"
    runs-on: ubuntu-latest
    needs: build-test

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: "maven"

      - if: ${{ hashFiles('**/*pom.xml') != '' && contains(steps.prepare_maven.outputs.plugins, 'spotless-maven-plugin') }}
        run: mvn spotless:check

      - run: |
          wget -q https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.17.0/checkstyle-10.17.0-all.jar -O checkstyle.jar
          java -jar checkstyle.jar \
            -c .github/config/checkstyle/checkstyle.xml \
            -f xml \
            -o checkstyle-result.xml \
            src/main/java src/test/java || true

      - name: Install xmlstarlet
        run: sudo apt-get update && sudo apt-get install -y xmlstarlet

      - name: Generate Checkstyle report
        run: |
          set -e
          echo "## Checkstyle Report" > checkstyle.md
          echo "" >> checkstyle.md
          echo "| File | Line | Message |" >> checkstyle.md
          echo "|------|------|---------|" >> checkstyle.md

          if [ ! -s checkstyle-result.xml ]; then
            echo "Nenhum relatório checkstyle-result.xml encontrado ou está vazio." >> checkstyle.md
            exit 0
          fi

          if command -v xmlstarlet >/dev/null 2>&1; then
            xmlstarlet sel -t -m "//file/error" -v "concat(../../@name, '|', @line, '|', @message)" -n checkstyle-result.xml | while IFS='|' read -r file line message; do
              echo "| $file | $line | $message |" >> checkstyle.md
            done
          else
            # Fallback usando grep e sed
            grep "<error " checkstyle-result.xml | sed -E 's/.*<file name="([^"]+)">.*line="([^"]+)" message="([^"]+)".*/|\1|\2|\3|/' | while IFS='|' read -r file line message; do
              echo "| $file | $line | $message |" >> checkstyle.md
            done
          fi

          # Verifica se o relatório está vazio (apenas cabeçalho)
          if [ $(wc -l < checkstyle.md) -le 3 ]; then
            echo "Nenhum problema de estilo de código encontrado." >> checkstyle.md
          fi
          
      - name: Add report to GitHub Job Summary
        run: cat checkstyle.md >> $GITHUB_STEP_SUMMARY

      - name: Post Checkstyle report to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: checkstyle.md

  # -------------------------------------------------------------
  # 4. SEGURANÇA DEPENDÊNCIAS
  # -------------------------------------------------------------

  # -------------------------------------------------------------
  # 5. SEGURANÇA B. SAST
  # -------------------------------------------------------------

  # -------------------------------------------------------------
  # 6. MERGE ENFORCEMENT
  # -------------------------------------------------------------
  enforce:
    name: "Enterprise Gatekeeper"
    runs-on: ubuntu-latest
    needs: [build-test, linting, architecture]

    steps:
      - name: All checks passed
        run: |
          echo "✔ Todas as etapas de Qualidade + Segurança concluídas."
